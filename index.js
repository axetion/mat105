var posters = [
	["WE ARE POWER", 
		["One of several posters to speak to a collective whole (students and workers) rather than a particular subset, \"Nous Sommes Le Pouvior\" exemplifies the Atelier Populaire's style of reductive but irregularly-shaped silhouettes.",
		"Emotion and humanity are added to an otherwise flat and rigid silhouette through these irregularities, most notable in the asymmetrical shaping of the iconic wrench. The silhouettes bleed into each other and overlap, not only heightening the sense of collective but also suggesting that this is not just a silhouette of six people but of an obscured crowd.",
		"Some individuality is retained through the assorted hats present on some of the silhouettes, which also hint at the varying professions of the workers in this collective.  "], 
		22, 17],
	["BE YOUNG AND SHUT UP", 
		["An early poster and one of the most iconic examples of the Atelier Populaire's propaganda aimed towards students, \"Sois Jeune et Tais-Toi\" is both visually and textually filled with contrasts.",
		"The messages \"be young\" and yet \"shut up\" contrast greatly tonally, with \"be young\" conveying the whimsical, care-free nature that the old attribute to the young, followed by the harsh and informal (especially considering the usage of \"toi,\" which is familiar in French) \"shut up.\"",
		"The vague form of the person silencing the youth is - somewhat ironically considering the anti- imperialist ideals of the movement overall - very Japonisme, consisting of one flatly colored and planar silhouette with only a few lines of negative space to define the hand and shirt cuff. The nose is snout-like in shape and the hat reminiscent of a police or military officer, making it clear who they consider to be doing the silencing.",
		"The figure of the youth, meanwhile, is carved out of the silhouette in negative space, with bits of its color left in to provide shading for the hair and the curiously dark rings around the eyes. "], 
		17, 17],
	["WE ARE ALL UNDESIRABLES", 
		["A rather unusual poster in that it features a realistic depiction of a youth's face compared to the simpler, more geometric illustrations of prior posters.",
		"Shading is featured most prominently around the eyes, hair, and nose (which otherwise would be easily lost amidst the rest of the monochromatic face).",
		"\"Indesirables\" is featured in inverted colors compared to the rest of the text, providing emphasis as well as matching it visually with the appearance of the face. "], 
		12, 17],
	["WORKERS UNITE - FRENCH/IMMIGRANT", 
		["An example of a poster aimed purely at workers over the student body, \"Travailleurs Unis\" (which is stunningly relevant today) calls for unity between French workers and their perceived competitors - cheap, immigrant labor from Algeria, a hotbed of French colonialism even after their independence in 1962.",
		"It depicts a tiny, stout businessman in a stereotypical fedora desperately attempting to separate two workers of contrasting color crossing their arms - literal brothers-in-arms, perhaps.",
		"Compositionally, the poster is rather geometric, with the businessman as an isosceles trapezoid and the workers and space between them largely rectangular. The perspective of the scene also appears to be at a slight upward pitch, with objects becoming narrower towards the top.",
		"The \"UNIS\" text at the bottom is of particular typographical note, as it features larger-than-normal counters and corners in the U and N which give the text emphasis without it actually taking up significantly more space vertically."], 13, 17],
	["BACK TO NORMAL", 
		["Another famous Atelier Populaire poster, \"Retour A La Normale\" was made in response to a perceived decline in the strength of the strikes going on, largely induced by the passage of several new laws by the French government aimed to appease the trade unions.", 
		"Here, those appeased by such measures are depicted as gullible sheep or rams.",
		"The spiral nature of the ram horns have been exaggerated to present a double meaning, with it appearing that cartoonish hypnosis swirls have replaced the heads and brains of the rams. "], 
		12, 18],
	["THE STRUGGLE CONTINUES", 
		["One of the most iconic and recognizable of the Atelier Popular posters, \"La Lutte Continue\" is a general call to action steeped in distinctive iconography.", 
		"The shape of the positive space is a rather geometric silhouette of a factory, with 45-45-90 triangles for the roof and thin lines of negative space to construct the brick pattern of its smokestack.",
		"Where one would expect billowing, fluid and insubstantial smoke emerging from the top of the smokestack, however, is instead a firm, clenched fist - a solid rallying cry that contrasts completely with one's expectations for the smokestack and yet also inherits some of the functional motion expected of smoke.",
		"As with many Atelier Popular posters, the text at the bottom is carved out of the positive space rather than being on its own line, thus saving vertical space overall. "], 
		18, 18],
	["PEOPLE'S UNIVERSITY, MAY 68", 
		["This poster references the student occupation of the University in Nanterre, which kickstarted the strikes and events of May '68.", 
		"The symbolism of the book and wrench, which is completely filled rather than outlined so as to make it appear clearly over the book, is representative of the students' desire to be taught practical skills rather than being separated from the working class. One of the initial demands of Nanterre students, who were originally merely protesting the new curriculum plans of the university, was that students be allowed to do work-studies in practical settings such as factories.",
		"Perhaps in reflection of this, the text and background feature a \"grungier\" appearance than most of the posters, with flecks of contrasting color interspersed at random."], 
		14, 18],
	["LONG LIVE THE GRASSROOTS UNITY OF THE WORKERS", 
		["A more direct call for unity at a difficult time for the strikers, \"Vive L'Unite des Travailleurs Par La Base\" exemplifies the clever usage of positive and negative space necessary for monochromatic prints such as this.",
		"As with \"La Lutte Continue,\" we are shown in the negative space a geometric depiction of a stretch of factories, with right triangles of varying sizes and rectangular smokestacks.",
		"Where the smokestacks of the two middle factories would have met, a triangular \"roof\" emerges, completing the shape of an upward arrow in the positive space between them.",
		"The background color is slightly warmer than a pure black, making it easier to see the arrow. "],
		23.1, 18],
	["THE STRUGGLE CONTINUES - WE SUPPORT THE STRIKE OF THE BOATMEN", 
		["Another example of a poster aimed at bridging students and workers, the boatmen this print tells of were an unusual case among the strikers - they were one of the first groups to go on strike, due to their meager pay and 80-hour work weeks, and were the longest lasting strikers.",
		"Perhaps as a symbol of their steely resolve (they even constructed dams in the canals to block the boats as part of their strike), this poster depicts a large rope attached firmly to a thimble.",
		"Typographically, this poster is one of few to feature letter spacing prominently for justification. "], 
		15.6, 21],
	["WILL HE BE UNEMPLOYED?", 
		["Amidst a sea of radical images aiming to tap into a largely young audience, \"Sera-t-il Chomeur\" presents a simple, more everyday, and yet unusually striking message - what about your children? Will they be employed?",
		"Visually, this poster is one of a few to use cool colors - a dark blue as opposed to a neutral black or easy-to-spot red.",
		"The shading and posture of the child, recumbent except for a tilted head and inquisitive expression, suggests that he has just been awoken by a sudden, harsh light - perhaps symbolizing the \"real world\" - positioned to one side, illuminating his face. The lettering of \"Sera-t-il Chomeur\" is also more irregular, injecting more child-like symbolism into its presentation.",
		"The lack of a well-defined background also creates the possibility that the child is falling through empty space, symbolic of how one might fall into poverty."], 
		26.25, 21],
	["THE POLICE POST THEMSELVES AT THE SCHOOL OF FINE ARTS\nTHE FINE ARTS STUDENTS POSTER THE STREETS", 
		["This poster, despite its implicit call for further action, is actually one of the last posters produced by the Atelier Populaire.",
		"It was made in response to a police raid of the workshop, which on its own did not affect the production of posters as the silkscreening equipment used was deliberately designed to be portable. Shortly afterwards, however, Charles de Gaulle's party won re-election which largely brought about an end to any public displays of opposition.",
		"Nevertheless, the text mocks the police with wordplay on post/poster (which come from the same verb in French) and features a typical animalistic depiction of a cop attempting to bite down - and failing due to his misshapen teeth - on a paintbrush.",
		"The \"dans la\" in \"dans la Rue\" (\"in the street\") is done in a gentle, hand-drawn cursive, which contrasts with the blocky sans-serif the rest of the poster is set in. This references the Atelier Popular motto \"la beauté est dans la rue,\" or \"Beauty is in the Streets.\""], 
		15.667, 21],
	["WITH AND FOR THE WORKERS\nTHE RAILWAY WORKERS ARE ON STRIKE, LET'S SUPPORT THEM", [
		"Another poster aimed at a particular sub-group of the strike, this poster celebrates the railway workers who laid down on the tracks to block trains from departing.", 
		"The rectangular depictions of the people blocking the tracks create a decidedly wall-like aesthetic, although the irregular nature of their heads provides some humanity to them still.",
		"\"Les Cheminots Sont En Greve\" (The railway workers are on strike) is written into the negative space of the wall of people, providing contrast and emphasis against the rest of the text. "], 
		16.8, 21]
];

var introSlides = [
	["ATELIER POPULAIRE", "On May 2nd, 1968, with tensions high due to previous disagreements between political student organizations as well as between the student body and faculty, a group of 300 students at the University of Nanterre gathered peacefully to protest the Vietnam War.\n\nThe response from the police at the University was tear gas.\nThe response from the students at universities throughout France were more protests.\nThe response from the police: more tear gas.\n\nAs more protests emerged and more student unions organized to protest their univerisities and the current government as a whole, workers across France joined in solidarity to form the largest general strike France had ever seen.\n\nKnown colloquially as \"May 68,\" the strike at its height consisted of almost two-thirds of the French workforce. The strike made a lasting impression on French history and popular culture.\n\nThe Atelier Populaire, or People's Workshop, was an organization of design students from the Parisian \"École Nationale Supérieure Des Beaux-Arts\" (National School of Fine Arts) committed to creating posters to aid the cause of the general strike.\n\nFor two months they created numerous postmodern designs, voted on them democratically, and reportedly printed and propagated hundreds of thousands of silkscreen prints of these designs until they were shut down by the police. Each poster was designed to be simple, favoring impact over realism, and appeal specifically to one of the numerous groups at play in the general strike, bringing them together as a unified front.\n\nThe Atelier Populaire's rejection of what they deemed to be toxic modernist art culture sealed them as a shining example of \"postmodernism of resistance.\""],
	["SILKSCREENING", "Silkscreening (also known as serigraphy) was the printing method of choice for the Atelier Populaire. Although it was not particularly popular in the fine arts until its promulgation by artists such as Andy Warhol in the 1960s, silkscreening has been used extensively for poster design due to its its speed and low cost - most notably, it was used by the U.S. Government's Federal Art Project designers in the 1930s and 1940s.\n\nThe process fundamentally requires multiple passes for each ink color used in the poster, which is why almost all Atelier Populaire posters are monochrome. Printing is performed by stretching the silkscreen out with a stencil layered on top that physically blocks ink from filling the negative space of the poster. A squeegee filled with ink is then run across the screen. The stencils themselves were created by applying a special filler material to a grease pencil drawing of the poster - the filler doesn't stick to the grease, allowing the filler to be dissolved away in the positive space and stay just in the negative space.\n\nAside from price, another advantage of silkscreening was the materials were portable - after the police raid of the workshop in late June, the students were able to move and continue printing for a while longer."]
];

var posterMeshes = [];
var scene = new THREE.Scene();
var raycaster = new THREE.Raycaster();
var imageLoader = new THREE.ImageLoader();

var currentCaption, captionProgress = -1, inTransition = false, endCallback, introProgress = 0;
var blinker, blinkDirection = 1;

function ease(obj, attrib, dest, duration)
{
	var t0 = 0;
	var start = +obj[attrib];

	function f(time)
	{
		if (t0 === 0)
		{
			t0 = time;
			requestAnimationFrame(f);
		}
		else
		{
			var t = (time - t0) / duration;

			if (t > 1)
			{
				obj[attrib] = dest;
			}
			else
			{
				obj[attrib] = (dest - start) * Math.sin(Math.PI / 2 * t) + start;
				requestAnimationFrame(f);
			}
		}
	}

	requestAnimationFrame(f);
}

function makeFlat(w, h, material)
{
	var mesh = new THREE.Mesh(new THREE.PlaneGeometry(w, h), material);
	scene.add(mesh);

	return mesh;
}

function updateCaption()
{
	inTransition = true;
	var captioninner = document.getElementById("captioninner");

	if (captionProgress < currentCaption.length)
	{
		ease(captioninner.style, "opacity", 0, 500);

		setTimeout(function()
		{
			captioninner.innerText = currentCaption[captionProgress];
			ease(captioninner.style, "opacity", 1, 500);
			inTransition = false;
		}, 500);
	}
	else
	{
		endCallback();
	}
}

function initGeom()
{
	var wall = makeFlat(256, 96, new THREE.MeshStandardMaterial({normalScale: {x: 0.4, y: 0.4}}));

	imageLoader.load("textures/wall.png", function(image)
	{
		var tex = new THREE.Texture();

		tex.wrapS = THREE.RepeatWrapping;
		tex.wrapT = THREE.RepeatWrapping;
		tex.repeat.set(6, 2);
		tex.image = image;
		tex.needsUpdate = true;

		wall.material.map = tex;
		wall.material.needsUpdate = true;
	});

	imageLoader.load("textures/wall-normal.png", function(image)
	{
		var tex = new THREE.Texture();

		tex.wrapS = THREE.RepeatWrapping;
		tex.wrapT = THREE.RepeatWrapping;
		tex.repeat.set(6, 2);
		tex.image = image;
		tex.needsUpdate = true;

		wall.material.normalMap = tex;
		wall.material.needsUpdate = true;
	});

	var floor = makeFlat(256, 256, new THREE.MeshStandardMaterial());
	floor.rotation.x = -Math.PI/2.0;
	floor.position.z = 256/2;
	floor.position.y = -96/2;

	imageLoader.load("textures/floor.png", function(image)
	{
		var floortex = new THREE.Texture();

		floortex.wrapS = THREE.RepeatWrapping;
		floortex.wrapT = THREE.RepeatWrapping;
		floortex.anisotropy = 4;
		floortex.repeat.set(6, 6);
		floortex.image = image;
		floortex.needsUpdate = true;

		floor.material.map = floortex;
		floor.material.needsUpdate = true;
	});

	imageLoader.load("textures/floor-normal.png", function(image)
	{
		var floortex = new THREE.Texture();

		floortex.wrapS = THREE.RepeatWrapping;
		floortex.wrapT = THREE.RepeatWrapping;
		floortex.anisotropy = 4;
		floortex.repeat.set(6, 6);
		floortex.image = image;
		floortex.needsUpdate = true;

		floor.material.normalMap = floortex;
		floor.material.needsUpdate = true;
	});

	var spot = new THREE.SpotLight(0xffffff, 0.2, 0, Math.PI / 2.0, 0, 2);
	spot.position.x = 256;
	spot.position.z = 128;
	spot.position.y = 96/2;

	spot.target.position.x = 64;
	spot.target.position.y = 0;
	spot.target.position.z = 16;
	spot.target.updateMatrixWorld();

	var hemi = new THREE.HemisphereLight(0xffffff, 0xcfcfcf, 1.0);

	scene.add(spot);
	scene.add(hemi);

	scene.fog = new THREE.Fog();
	scene.fog.color = new THREE.Color(0xafafaf);
	scene.fog.near = 96;
	scene.fog.far = 256;
}

function initPosters()
{
	var maxHeight = 0;

	for (var i = 0, x = -10, y = 96/2 - 10; i < posters.length; i++)
	{
		var posterInfo = posters[i];
		var width = posterInfo[2];
		var height = posterInfo[3];

		maxHeight = Math.max(height, maxHeight);

		var posterMesh = makeFlat(width, height, new THREE.MeshLambertMaterial({transparent: true, opacity: 1}));

		posterMesh.position.x = x + width / 2;
		posterMesh.position.y = y - height / 2;
		posterMesh.position.z = 1;

		var posterLight = new THREE.PointLight(0xffffff, 1, 10, 2);

		posterLight.position.x = x;
		posterLight.position.y = y;
		posterLight.position.z = 2;

		scene.add(posterLight);

		imageLoader.load("posters/" + i + ".png", function(image)
		{
			var postertex = new THREE.Texture();

			postertex.minFilter = THREE.LinearFilter;
			postertex.wrapS = THREE.ClampToEdgeWrapping;
			postertex.wrapT = THREE.ClampToEdgeWrapping;
			postertex.image = image;
			postertex.needsUpdate = true;

			this.material.map = postertex;
			this.material.needsUpdate = true;
		}.bind(posterMesh));

		x += width + 3;

		if (i % 4 === 3)
		{
			x = -10;
			y -= maxHeight + 3;
			maxHeight = 0;
		}

		posterMeshes.push([posterMesh, posterLight]);
	}
}

function beginRender()
{
	var camera = new THREE.PerspectiveCamera(45, 0, 0.1, 512);
	camera.position.x = -5;
	camera.position.z = 128;
	camera.rotation.y = -Math.PI/6.0;

	var renderer = new THREE.WebGLRenderer({antialias: true});
	renderer.setClearColor(0xafafaf, 1);

	function render()
	{
		requestAnimationFrame(render);
		renderer.render(scene, camera);
	}

	function click(event)
	{
		renderer.domElement.removeEventListener("click", click);

		raycaster.setFromCamera(new THREE.Vector2(2 * event.clientX / window.innerWidth - 1, -2 * event.clientY / window.innerHeight + 1), camera);
		var poster = raycaster.intersectObjects(scene.children);

		if (poster.length > 1)
		{
			poster = poster[0].object;

			var titleElem = document.getElementById("title");
			var captionElem = document.getElementById("caption");
			var leftControl = document.getElementById("left");
			var rightControl = document.getElementById("right");
			var height;

			for (var i = 0; i < posterMeshes.length; i++)
			{
				var otherPoster = posterMeshes[i][0];
				var light = posterMeshes[i][1];

				if (poster.uuid !== otherPoster.uuid)
				{
					ease(otherPoster.material, "opacity", 0, 1000);
					light.intensity = 0;
				}
				else
				{
					var posterInfo = posters[i];

					titleElem.innerText = posterInfo[0];
					currentCaption = posterInfo[1];
					height = posterInfo[3];

					ease(light, "intensity", 0, 1000);

					setTimeout(function() {
						scene.remove(this);
					}.bind(light), 1000);
				}
			}

			captionProgress = 0;
			document.getElementById("captioninner").innerText = "";

			leftControl.addEventListener("click", function(_)
			{
				if (inTransition)
				{
					return;
				}

				if (captionProgress > 0)
				{
					captionProgress--;
					updateCaption();
				}
			});

			rightControl.addEventListener("click", function(_)
			{
				if (inTransition)
				{
					return;
				}

				captionProgress++;
				updateCaption();
			});

			endCallback = function()
			{
				leftControl.removeEventListener("click", click);
				rightControl.removeEventListener("click", click);

				ease(titleElem.style, "opacity", 0, 500);
				ease(captionElem.style, "opacity", 0, 500);
				ease(leftControl.parentElement.style, "opacity", 0, 500);

				ease(poster.material.color, "r", 0.75, 1000);
				ease(poster.material.color, "g", 0.75, 1000);
				ease(poster.material.color, "b", 0.75, 1000);

				setTimeout(function()
				{
					ease(camera.rotation, "y", -Math.PI/6.0, 1000);
					ease(camera.position, "z", 128, 1000);
					ease(camera.position, "x", (camera.aspect - 2) * 25, 1000);
					ease(camera.position, "y", 0, 1000);

					for (var i = 0; i < posterMeshes.length; i++)
					{
						ease(posterMeshes[i][0].material, "opacity", 1, 1000);
						ease(posterMeshes[i][1], "intensity", 1, 1000);
					}

					renderer.domElement.addEventListener("click", click);
					captionProgress = -1;
				}, 500);
			};

			ease(camera.rotation, "y", 0, 1000);
			ease(camera.position, "z", 48, 1000);
			ease(camera.position, "x", poster.position.x, 1000);
			ease(camera.position, "y", poster.position.y - height / 2 + 2, 1000);

			setTimeout(function()
			{
				ease(titleElem.style, "opacity", 1, 500);
				ease(captionElem.style, "opacity", 1, 1000);
				ease(leftControl.parentElement.style, "opacity", 1, 1000);

				updateCaption();
			}, 1000);
		}
	}

	function resize()
	{
		camera.aspect = Math.max(window.innerWidth / window.innerHeight, 1);

		if (captionProgress == -1)
		{
			camera.position.x = (camera.aspect - 2) * 25;
		}

		camera.updateProjectionMatrix();

		var h = window.innerWidth / camera.aspect;
		renderer.setSize(window.innerWidth, h);

		renderer.domElement.style.top = (window.innerHeight - h) / 2 + "px";
	}

	renderer.domElement.style.position = "absolute";
	resize();

	window.addEventListener("resize", resize);
	renderer.domElement.addEventListener("click", click);
	document.body.appendChild(renderer.domElement);
	document.body.style.backgroundColor = "#afafaf";

	renderer.domElement.style.opacity = 0;
	ease(renderer.domElement.style, "opacity", 1, 1500);
	render();
}

function updateIntro()
{
	var container = document.getElementById("introContainer");
	var intro = document.getElementById("intro");
	var header = document.getElementById("header");

	var introContent = introSlides[introProgress++];

	if (introProgress <= introSlides.length)
	{
		ease(container.style, "opacity", 0, 500);

		setTimeout(function()
		{
			header.innerText = introContent[0];
			intro.innerText = introContent[1];
	
			ease(container.style, "opacity", 1, 500);
		}, 500);
	}
	else
	{
		clearInterval(blinker);

		var introskip = document.getElementById("introskip");
		var bibliography = document.getElementById("bibliography");
	
		introskip.parentNode.removeChild(introskip);
		bibliography.parentNode.removeChild(bibliography);

		ease(container.style, "opacity", 0, 1000);

		setTimeout(function()
		{
			container.parentNode.removeChild(container);
			beginRender();
		}, 1000);
	}
}

initGeom();
initPosters();
updateIntro();

var blinkerElem = document.getElementById("blinker");

blinker = setInterval(function()
{
	ease(blinkerElem.style, "opacity", blinkDirection, 1000);
	blinkDirection = !blinkDirection;
}, 1000);
